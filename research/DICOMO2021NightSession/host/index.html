<!doctype html>
<html lang="ja">

<head>
    <title>釣リモート：ホスト</title>
    <meta http-equiv="content-type" charset="utf-8">
    <link href="style.css" rel="stylesheet">

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

    <!-- SkyWay -->
    <script src="https://cdn.webrtc.ecl.ntt.com/skyway-4.4.1.js"></script>
    <script>
        const API_KEY = '6fbdac52-19fb-4a75-93f0-987522d95c9a';
    </script>
</head>

<body>
    <div class="alert alert-secondary" id="status">
        未接続
    </div>

    <button type="button" class="btn btn-primary" id="call-button" onclick="call();">
        接続
    </button>

    <script>
        function call() {
            $('#call-button').prop('disabled', true);
            $('#status').addClass('alert-primary');
            $('#status').removeClass('alert-secondary');
            $('#status').removeClass('alert-danger');
            $('#status').text('接続準備中');

            let localStream = null;
            navigator.mediaDevices.getUserMedia({ video: false, audio: true })
                .then(function (stream) {
                    localStream = stream;

                    const peer = new Peer({ key: API_KEY });

                    peer.on('open', function () {
                        $('#status').text('接続待機中．．．');
                    });

                    peer.on('call', function (call) {
                        peer.call('DICOMO2021', localStream);

                        $('#status').addClass('alert-success');
                        $('#status').removeClass('alert-primary');
                        $('#status').text('通信中');
                    });

                }).catch(function (error) {
                    $('#call-button').prop('disabled', false);
                    $('#status').addClass('alert-danger');
                    $('#status').removeClass('alert-primary');
                    $('#status').text('接続失敗');
                });
        }
    </script>
</body>

</html>