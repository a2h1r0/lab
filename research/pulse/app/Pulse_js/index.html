<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs="
      crossorigin="anonymous"
    ></script>
  </head>

  <body>
    <style>
      body {
        width: 100%;
        height: 100vh;
      }
    </style>

    <script>
      const filename = "20200926_233009_fujii.csv";
      const skip_rows = 2;
      const HIGH = 580;
      const LOW = 470;

      var pulseData = [];
      var RGBdata = [];

      function getCSV() {
        var req = new XMLHttpRequest();
        req.open("get", filename, true);
        req.send(null);

        req.onload = function () {
          convertCSVtoArray(req.responseText);
          makeRGBdata();
          main();
        };
      }

      function convertCSVtoArray(csvString) {
        csvString.split("\n").forEach((row) => {
          pulseData.push(row.split(",")[1]);
        });

        for (var i = 0; i < skip_rows; i++) {
          pulseData.shift();
        }

        console.log("---csv_data---");
        console.log(pulseData);
        console.log("--------------");
      }

      function makeRGBdata() {
        pulseData.forEach((row) => {
          if (row < LOW) {
            RGBdata.push("rgb(168, 37, 38)");
          } else if (HIGH < row) {
            RGBdata.push("rgb(165, 34, 35)");
          } else {
            RGBdata.push("rgb(167, 35, 37)");
          }
        });

        console.log("---RGB_data---");
        console.log(RGBdata);
        console.log("--------------");
      }

      var colors = [];
      function main() {
        if (colors.length === 0) {
          colors = [].concat(RGBdata);
        }

        console.log(colors[0]);
        $("body").css("background-color", colors[0]);
        colors.shift();

        setTimeout(function () {
          main();
        }, 10);
      }

      getCSV();
    </script>
  </body>
</html>
