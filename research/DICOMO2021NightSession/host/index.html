<!doctype html>
<html lang="ja">

<head>
    <title>釣リモート：ホスト</title>
    <meta http-equiv="content-type" charset="utf-8">
    <link href="style.css" rel="stylesheet">

    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"
        integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

    <!-- SkyWay -->
    <script src="https://cdn.webrtc.ecl.ntt.com/skyway-4.4.1.js"></script>
    <script>
        const API_KEY = '6fbdac52-19fb-4a75-93f0-987522d95c9a';
        const peer = new Peer('DICOMO2021', { key: API_KEY });
    </script>
</head>

<body>
    <h1>ホスト</h1>
    
    <div class="container">
        <video muted autoplay id="send-video"></video>
    </div>

    <div class="alert alert-secondary" id="status">
        未接続
    </div>

    <div class="container">
        <button type="button" class="btn btn-primary" id="call-button" onclick="call();">
            接続
        </button>
    </div>

    <script>
        function call() {
            $('#call-button').prop('disabled', true);
            $('#status').addClass('alert-primary');
            $('#status').removeClass('alert-secondary');
            $('#status').removeClass('alert-danger');
            $('#status').text('接続待機中．．．');

            let localStream = null;
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(function (stream) {
                    localStream = stream;
                    $('#send-video').get(0).srcObject = localStream;

                    // 着信処理
                    peer.on('call', function (call) {
                        call.answer(localStream);

                        $('#status').addClass('alert-success');
                        $('#status').removeClass('alert-primary');
                        $('#status').text('通信中');
                    });
                }).catch(function (error) {
                    // メディア接続エラー
                    $('#call-button').prop('disabled', false);
                    $('#status').addClass('alert-danger');
                    $('#status').removeClass('alert-primary');
                    $('#status').text('接続失敗');
                });
        }

        // 終了処理
        $(window).on('beforeunload', function () {
            peer.destroy();
        });
    </script>
</body>

</html>